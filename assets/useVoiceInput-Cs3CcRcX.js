import{r as h}from"./iframe-Zi-gTbRm.js";import{l as o}from"./logger-CDMKXnH4.js";class f{getName(){return"Browser (Web Speech API)"}isAvailable(){const s=window;return!!(s.SpeechRecognition||s.webkitSpeechRecognition)}start(s,a,r){const i=window,t=i.SpeechRecognition||i.webkitSpeechRecognition;if(!t)return r({code:"not-supported",message:"Browser does not support Web Speech API"}),()=>{};try{o.info("Voice","Starting Browser Speech Recognition...");const e=new t;return e.continuous=!1,e.interimResults=!1,e.lang=s||navigator.language||"en-US",e.onresult=d=>{const n=d.results[0]?.[0];n&&(o.info("Voice","Browser transcript received",{text:n.transcript,confidence:n.confidence}),a({transcript:n.transcript,confidence:n.confidence}))},e.onerror=d=>{const n=d.error;n==="no-speech"||n==="aborted"||(r(n==="not-allowed"?{code:"permission-denied",message:"Microphone access denied. Please check permissions."}:n==="network"?{code:"network",message:"Network error. Browser voice input requires internet connection."}:{code:n,message:`Voice input error: ${n}`}),o.error("Voice","Browser recognition error",n))},e.start(),()=>{try{e.abort(),o.info("Voice","Browser recognition stopped")}catch(d){o.warn("Voice","Error stopping recognition",d)}}}catch(e){return o.error("Voice","Failed to initialize Browser recognition",e),r({code:"initialization-failed",message:"Failed to initialize voice input"}),()=>{}}}}class w{config;mediaRecorder=null;audioChunks=[];constructor(s){this.config=s}getName(){return"OpenAI (Whisper)"}isAvailable(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}start(s,a,r){return this.config.apiKey?(o.info("Voice","Starting OpenAI Whisper recording..."),this.audioChunks=[],navigator.mediaDevices.getUserMedia({audio:!0}).then(i=>{this.mediaRecorder=new MediaRecorder(i),this.mediaRecorder.ondataavailable=t=>{t.data.size>0&&this.audioChunks.push(t.data)},this.mediaRecorder.onstop=async()=>{o.info("Voice","Recording stopped, sending to Whisper API...");const t=new Blob(this.audioChunks,{type:"audio/webm"});try{const e=await this.transcribeWithWhisper(t,s);o.info("Voice","Whisper transcript received",{text:e}),a({transcript:e})}catch(e){o.error("Voice","Whisper API error",e),r({code:"api-error",message:e instanceof Error?e.message:"Failed to transcribe audio"})}finally{i.getTracks().forEach(e=>e.stop())}},this.mediaRecorder.start(),o.info("Voice","MediaRecorder started")}).catch(i=>{o.error("Voice","Failed to access microphone",i),r({code:"permission-denied",message:"Microphone access denied. Please check permissions."})}),()=>{this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop()}):(r({code:"missing-api-key",message:"OpenAI API key is required. Please configure in settings."}),()=>{})}async transcribeWithWhisper(s,a){const r=new FormData;r.append("file",s,"audio.webm"),r.append("model",this.config.model||"whisper-1"),a&&r.append("language",a.split("-")[0]);const i=this.config.baseUrl||"https://api.openai.com/v1/audio/transcriptions",t=await fetch(i,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`},body:r});if(!t.ok){const d=await t.text();throw new Error(`OpenAI API error: ${t.status} - ${d}`)}return(await t.json()).text||""}}class b{config;mediaRecorder=null;audioChunks=[];constructor(s){this.config=s}getName(){return"Google Gemini (Speech-to-Text)"}isAvailable(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}start(s,a,r){return this.config.apiKey?(o.info("Voice","Starting Gemini speech recording..."),this.audioChunks=[],navigator.mediaDevices.getUserMedia({audio:!0}).then(i=>{this.mediaRecorder=new MediaRecorder(i),this.mediaRecorder.ondataavailable=t=>{t.data.size>0&&this.audioChunks.push(t.data)},this.mediaRecorder.onstop=async()=>{o.info("Voice","Recording stopped, sending to Gemini API...");const t=new Blob(this.audioChunks,{type:"audio/webm"});try{const e=await this.transcribeWithGemini(t,s);o.info("Voice","Gemini transcript received",{text:e}),a({transcript:e})}catch(e){o.error("Voice","Gemini API error",e),r({code:"api-error",message:e instanceof Error?e.message:"Failed to transcribe audio"})}finally{i.getTracks().forEach(e=>e.stop())}},this.mediaRecorder.start(),o.info("Voice","MediaRecorder started")}).catch(i=>{o.error("Voice","Failed to access microphone",i),r({code:"permission-denied",message:"Microphone access denied. Please check permissions."})}),()=>{this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop()}):(r({code:"missing-api-key",message:"Gemini API key is required. Please configure in settings."}),()=>{})}async transcribeWithGemini(s,a){const r=await this.blobToBase64(s),i=`https://generativelanguage.googleapis.com/v1beta/models/${this.config.model||"gemini-1.5-flash"}:generateContent?key=${this.config.apiKey}`,t={contents:[{parts:[{text:`Transcribe this audio to text${a?` in ${a}`:""}.`},{inline_data:{mime_type:"audio/webm",data:r}}]}]},e=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){const p=await e.text();throw new Error(`Gemini API error: ${e.status} - ${p}`)}return(await e.json()).candidates?.[0]?.content?.parts?.[0]?.text||""}async blobToBase64(s){return new Promise((a,r)=>{const i=new FileReader;i.onloadend=()=>{const t=i.result.split(",")[1];a(t)},i.onerror=r,i.readAsDataURL(s)})}}const R=(c,s,a)=>{const[r,i]=h.useState(!1),[t,e]=h.useState(null),d=h.useCallback(()=>{if(!c.enabled){o.warn("Voice","Voice input is disabled in settings");return}let p=null;switch(c.activeProvider){case"browser":p=new f;break;case"openai":p=new w(c.providers.openai);break;case"gemini":p=new b(c.providers.gemini);break;default:a(`Unknown voice provider: ${c.activeProvider}`);return}if(!p.isAvailable()){a(`${p.getName()} is not available in this browser.`),o.error("Voice",`Provider ${p.getName()} is not available`);return}o.info("Voice",`Starting ${p.getName()}...`,{language:c.language||navigator.language}),i(!0);const u=l=>{o.info("Voice","Transcription received",{text:l.transcript,confidence:l.confidence}),i(!1),s(l.transcript)},g=l=>{o.error("Voice","Voice input error",l),i(!1),a(l.message)},m=p.start(c.language,u,g);e(()=>m)},[c,s,a]),n=h.useCallback(()=>{t&&(t(),e(null)),i(!1)},[t]);return{isListening:r,start:d,stop:n}};export{R as u};
